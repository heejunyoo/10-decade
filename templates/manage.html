{% extends "base.html" %}

{% block title %}Manage Memories - The Decade Journey{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 pt-24 max-w-7xl animate-fade-in">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-8">
        <div class="header-left">
            <h2 class="text-3xl font-serif text-primary">‚öôÔ∏è Memory Management</h2>
        </div>
        <div class="flex flex-wrap items-center gap-3">
            <form action="/manage" method="get"
                class="flex items-center border border-gray-300 rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-accent/50 transition-shadow">
                <input type="text" name="q" value="{{ q }}" placeholder="Search memories..."
                    class="px-3 py-2 outline-none text-sm w-48 bg-transparent">
                <button type="submit"
                    class="px-3 py-2 bg-gray-50 hover:bg-gray-100 border-l border-gray-300 text-gray-600">üîç</button>
            </form>
            <a href="/manage/people"
                class="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition-colors text-sm">üë•
                Manage People</a>
            <a href="/add"
                class="bg-primary text-white border border-transparent px-4 py-2 rounded-lg font-medium hover:bg-primary/90 transition-colors text-sm shadow-sm flex items-center gap-2">‚ûï
                Add Memory</a>
        </div>
    </div>

    <div class="overflow-hidden rounded-xl shadow-sm border border-gray-200 bg-white">
        <table class="w-full text-left border-collapse">
            <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Date</th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider w-20">Thumb</th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">Details</th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">AI Insight ü§ñ
                    </th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider">User Memories üí≠
                    </th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider w-16">ID</th>
                    <th class="px-6 py-4 text-xs font-semibold text-gray-500 uppercase tracking-wider text-right">
                        Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for event in events %}
                <tr data-id="{{ event.id }}" class="hover:bg-gray-50/50 transition-colors group">
                    <td class="px-6 py-4 text-sm text-gray-600 font-mono whitespace-nowrap">{{ event.date }}</td>
                    <td class="px-6 py-4">
                        {% if event.thumbnail_url %}
                        <div
                            class="w-12 h-12 rounded-lg overflow-hidden bg-gray-100 border border-gray-200 shadow-sm shrink-0">
                            <img src="{{ event.thumbnail_url }}" alt="Thumb" loading="lazy"
                                class="w-full h-full object-cover">
                        </div>
                        {% elif event.image_url %}
                        {% if event.media_type != 'video' %}
                        <div
                            class="w-12 h-12 rounded-lg overflow-hidden bg-gray-100 border border-gray-200 shadow-sm shrink-0">
                            <img src="{{ event.image_url }}" alt="Thumb" loading="lazy"
                                class="w-full h-full object-cover">
                        </div>
                        {% else %}
                        <div class="w-12 h-12 rounded-lg overflow-hidden bg-red-50 border border-red-100 text-red-500 flex items-center justify-center text-xl shrink-0"
                            title="Video">
                            üé¨
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="w-12 h-12 rounded-lg overflow-hidden bg-blue-50 border border-blue-100 text-blue-500 flex items-center justify-center text-xl shrink-0"
                            title="Text Note">
                            üìù
                        </div>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 max-w-xs">
                        {% if event.description %}
                        <p class="text-gray-800 text-sm line-clamp-2 mb-2">{{ event.description }}</p>
                        {% else %}
                        <p class="text-gray-400 italic text-sm mb-2">No description</p>
                        {% endif %}

                        {% if event.tags %}
                        <div class="flex flex-wrap gap-1.5">
                            {% for tag in event.tags.split(',') %}
                            <span
                                class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-600 border border-gray-200">
                                {{ tag.strip() }}
                            </span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </td>

                    <!-- AI Insight Column -->
                    <td class="px-6 py-4 max-w-xs">
                        {% if event.summary %}
                        <div class="text-sm text-gray-600 max-h-20 overflow-y-auto custom-scrollbar">
                            {{ event.summary }}
                        </div>
                        {% else %}
                        <span class="text-xs text-gray-400 italic">Processing...</span>
                        {% endif %}
                    </td>

                    <!-- User Memories Column -->
                    <td class="px-6 py-4 max-w-xs">
                        {% if event.interactions %}
                        <div class="space-y-2">
                            {% for interaction in event.interactions %}
                            {% if interaction.is_answered %}
                            <div class="pl-2 border-l-2 border-accent/30 text-xs">
                                <div class="text-gray-500 mb-0.5">Q: {{ interaction.question }}</div>
                                <div class="text-gray-800 font-medium">A: {{ interaction.answer }}</div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% else %}
                        <span class="text-gray-300">-</span>
                        {% endif %}
                    </td>

                    <td class="px-6 py-4 text-xs text-gray-400 font-mono">#{{ event.id }}</td>
                    <td class="px-6 py-4 text-right">
                        <div
                            class="flex items-center justify-end gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                            <a href="/edit/{{ event.id }}"
                                class="p-2 text-blue-500 hover:bg-blue-50 rounded-lg transition-colors border border-transparent hover:border-blue-100"
                                title="Edit">
                                ‚úèÔ∏è
                            </a>
                            <button onclick="confirmDelete('{{ event.id }}')"
                                class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors border border-transparent hover:border-red-100"
                                title="Delete">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}

                {% if events|length == 0 %}
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                        <div class="flex flex-col items-center justify-center gap-2">
                            <span class="text-2xl">üîç</span>
                            <p>No memories found matching your search.</p>
                        </div>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="flex justify-center items-center gap-4 mt-8">
        {% if page > 1 %}
        <a href="/manage?page={{ page - 1 }}{% if q %}&q={{ q }}{% endif %}"
            class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50 transition-colors">‚Üê
            Prev</a>
        {% else %}
        <span class="px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-400 cursor-not-allowed">‚Üê
            Prev</span>
        {% endif %}

        <span class="text-sm text-gray-600 font-medium">Page {{ page }} of {{ total_pages }}</span>

        {% if page < total_pages %} <a href="/manage?page={{ page + 1 }}{% if q %}&q={{ q }}{% endif %}"
            class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm text-gray-700 hover:bg-gray-50 transition-colors">
            Next ‚Üí</a>
            {% else %}
            <span
                class="px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-400 cursor-not-allowed">Next
                ‚Üí</span>
            {% endif %}
    </div>
    {% endif %}

    <details open
        class="mt-12 bg-white/50 backdrop-blur-sm border border-gray-200 rounded-xl overflow-hidden shadow-sm">
        <summary
            class="px-6 py-4 cursor-pointer font-bold text-primary bg-gray-50/50 hover:bg-gray-50 flex items-center justify-between select-none">
            <span>üõ†Ô∏è System Configuration</span>
            <span class="opacity-50 text-sm">Design & AI Settings</span>
        </summary>
        <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-8">

            <!-- 1. Design Theme -->
            <div class="md:col-span-2">
                <h3 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wider">üé® Design Concept</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">

                    <!-- Classic -->
                    <button class="theme-btn relative p-4 rounded-xl border-2 transition-all duration-200 text-left hover:shadow-md
                        {% if not get_config('theme') or get_config('theme') == 'classic' %}
                        border-accent bg-white text-primary ring-2 ring-accent/20
                        {% else %}
                        border-transparent bg-gray-50 text-gray-500 hover:bg-gray-100
                        {% endif %}" onclick="updateSetting('theme', 'classic')">
                        <div class="font-bold text-lg mb-1 font-serif">Classic</div>
                        <span class="block text-xs opacity-70">Warm & Nostalgic</span>
                        {% if not get_config('theme') or get_config('theme') == 'classic' %}
                        <div class="absolute top-2 right-2 text-accent">‚úì</div>
                        {% endif %}
                    </button>

                    <!-- Nexus -->
                    <button class="theme-btn relative p-4 rounded-xl border-2 transition-all duration-200 text-left hover:shadow-md group
                        {% if get_config('theme') == 'nexus' or get_config('theme') == 'palantir' %}
                        border-blue-500 bg-slate-800 text-blue-400 ring-2 ring-blue-500/20
                        {% else %}
                        border-transparent bg-slate-100 text-slate-500 hover:bg-slate-200
                        {% endif %}" onclick="updateSetting('theme', 'nexus')">
                        <div class="font-bold text-lg mb-1 font-sans">Nexus</div>
                        <span class="block text-xs opacity-70">Cyber & Dark</span>
                        {% if get_config('theme') == 'nexus' or get_config('theme') == 'palantir' %}
                        <div class="absolute top-2 right-2 text-blue-500">‚úì</div>
                        {% endif %}
                    </button>

                    <!-- Forest -->
                    <button class="theme-btn relative p-4 rounded-xl border-2 transition-all duration-200 text-left hover:shadow-md
                        {% if get_config('theme') == 'forest' %}
                        border-emerald-600 bg-emerald-50 text-emerald-800 ring-2 ring-emerald-600/20
                        {% else %}
                        border-transparent bg-gray-50 text-gray-500 hover:bg-gray-100
                        {% endif %}" onclick="updateSetting('theme', 'forest')">
                        <div class="font-bold text-lg mb-1 font-serif">Forest</div>
                        <span class="block text-xs opacity-70">Nature & Calm</span>
                        {% if get_config('theme') == 'forest' %}
                        <div class="absolute top-2 right-2 text-emerald-600">‚úì</div>
                        {% endif %}
                    </button>

                    <!-- Retro -->
                    <button class="theme-btn relative p-4 rounded-xl border-2 transition-all duration-200 text-left hover:shadow-md
                        {% if get_config('theme') == 'retro' %}
                        border-amber-600 bg-amber-50 text-amber-800 ring-2 ring-amber-600/20
                        {% else %}
                        border-transparent bg-gray-50 text-gray-500 hover:bg-gray-100
                        {% endif %}" onclick="updateSetting('theme', 'retro')">
                        <div class="font-bold text-lg mb-1 font-serif">Retro</div>
                        <span class="block text-xs opacity-70">Vintage & Film</span>
                        {% if get_config('theme') == 'retro' %}
                        <div class="absolute top-2 right-2 text-amber-600">‚úì</div>
                        {% endif %}
                    </button>

                </div>
            </div>

            <!-- 2. AI Provider -->
            <div class="setting-group">
                <h3 style="margin-bottom: 1rem; font-size: 1.1rem;">üß† AI Engine</h3>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">Provider</label>
                    <select id="aiProvider" onchange="updateSetting('ai_provider', this.value)"
                        style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd; width: 100%;">
                        <option value="local" {% if get_config('ai_provider')=='local' %}selected{% endif %}>Local
                            (Florence-2 / Ollama)</option>
                        <option value="gemini" {% if get_config('ai_provider')=='gemini' %}selected{% endif %}>Google
                            Gemini API (Default)</option>
                        <option value="groq" {% if get_config('ai_provider')=='groq' %}selected{% endif %}>Groq (Llama
                            3.2 Vision) ‚ö°</option>
                    </select>
                </div>

                <!-- Gemini/Groq Status Helper -->
                <p class="text-xs text-gray-500 mt-2">
                    * API Keys (GEMINI/GROQ) are managed in <code>.env</code> file.
                </p>

            </div>
        </div>
    </details>

    <style>
        .setting-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 6px;
        }

        .theme-btn {
            flex: 1;
            padding: 1rem;
            border: 2px solid transparent;
            border-radius: 8px;
            background: #f1f5f9;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        [data-theme="palantir"] .theme-btn {
            background: #1e293b;
            color: #ccc;
        }

        .theme-btn.active {
            border-color: var(--accent-color);
            background: var(--white);
            color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
    </style>

    <div id="toast"
        class="fixed top-24 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl transform translate-x-full transition-transform duration-300 z-[9999]">
        <span id="toast-msg">Notification</span>
    </div>

    <script>
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            toastMsg.innerText = msg;

            if (type === 'error') {
                toast.classList.remove('bg-gray-800');
                toast.classList.add('bg-red-600');
            } else {
                toast.classList.remove('bg-red-600');
                toast.classList.add('bg-gray-800');
            }

            toast.classList.remove('translate-x-full');
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        }

        async function updateSetting(key, value) {
            try {
                // Special handling for Local Mode switch
                if (key === 'ai_provider' && value === 'local') {
                    showToast("Initializing Local AI Models... (may take 10-20s)", 'info');
                }

                const res = await fetch('/api/settings/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key, value })
                });

                const data = await res.json();

                if (res.ok) {
                    if (key === 'ai_provider' && value === 'local') {
                        // Trigger Warmup
                        try {
                            const warmupRes = await fetch('/api/settings/warmup');
                            if (warmupRes.ok) {
                                showToast("‚úÖ Local AI Models Loaded & Ready!");
                            } else {
                                throw new Error("Model Load Failed");
                            }
                        } catch (e) {
                            showToast("‚ö†Ô∏è Local AI Load Failed (Missing Libraries?). Reverting to Gemini.", 'error');
                            // Revert UI
                            document.getElementById('aiProvider').value = 'gemini';
                            updateSetting('ai_provider', 'gemini');
                            return;
                        }
                    } else {
                        showToast(data.message || "Setting Updated!");
                    }

                    if (key === 'theme') {
                        setTimeout(() => location.reload(), 500);
                    }
                } else {
                    showToast(data.message || "Error updating setting", 'error');
                }
            } catch (e) {
                showToast("Network Error: " + e, 'error');
            }
        }




    </script>


    <!-- Danger Zone -->
    <details class="mt-12 bg-red-50 border border-red-200 rounded-xl overflow-hidden">
        <summary
            class="px-6 py-4 cursor-pointer text-red-700 font-bold hover:bg-red-100 flex items-center gap-2 select-none">
            ‚ö†Ô∏è Danger Zone
        </summary>
        <div class="p-6">
            <p class="text-red-600 mb-4">Deleting all memories is irreversible. Please be certain.</p>
            <button onclick="confirmDeleteAll()"
                class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg shadow-sm transition-colors">DELETE
                ALL DATA</button>
        </div>
    </details>

    <!-- Hidden Form for Delete All -->
    <form id="deleteAllForm" action="/delete-all" method="post" style="display: none;"></form>
</div>



<script>
    function confirmDeleteAll() {
        if (confirm("üö® WARNING: Are you absolutely sure? This will wipe ALL data.")) {
            const verification = prompt("To confirm, type 'DELETE' in all caps:");
            if (verification === "DELETE") {
                document.getElementById('deleteAllForm').submit();
            } else {
                alert("Deletion cancelled.");
            }
        }
    }
</script>
{% endblock %}