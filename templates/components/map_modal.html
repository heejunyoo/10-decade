<!-- Global Map Modal -->
<div id="mapModal" class="modal-overlay" style="display: none; z-index: 3000;">
    <div class="modal-content map-modal-content">
        <button class="close-modal" onclick="closeMapModal()">&times;</button>
        <div id="interactiveMap" style="width: 100%; height: 100%;"></div>
    </div>
</div>

<style>
    .map-modal-content {
        width: 95%;
        height: 90vh;
        max-width: 1400px;
        background: #fff;
        /* Map usually looks better on white or use dark tiles */
        padding: 0;
        /* Full bleed */
        position: relative;
    }

    /* Custom Marker Styles */
    .custom-pin {
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s;
    }

    .custom-pin:hover {
        transform: scale(1.1);
        z-index: 1000 !important;
    }

    .current-photo-pin {
        border: 3px solid #ef4444;
        /* Red-500 */
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.6);
        z-index: 999 !important;
    }
</style>

<script>
    let mapInstance = null;
    let markersCluster = null;
    let currentFocusMarker = null;

    async function openMapModal(lat, lng, focusId) {
        if (!lat || !lng) {
            alert("No location data available.");
            return;
        }

        const modal = document.getElementById('mapModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        // Initialize Map if needed
        if (!mapInstance) {
            setTimeout(() => initMap(lat, lng), 100);
        } else {
            setTimeout(() => {
                mapInstance.invalidateSize();
                mapInstance.setView([lat, lng], 13); // Default zoom
            }, 100);
        }

        // Fetch Nearby Markers (Real-time Context)
        try {
            // Radius 10km to give enough context
            const res = await fetch(`/api/map/nearby?lat=${lat}&lng=${lng}&radius_km=10`);
            const nearbyData = await res.json();
            renderMarkers(nearbyData, focusId);
        } catch (e) {
            console.error("Failed to load map markers", e);
        }
    }

    function initMap(lat, lng) {
        // Dark Mode check? Use standard OSM for now.
        mapInstance = L.map('interactiveMap').setView([lat, lng], 13);

        // CartoDB Voyager
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(mapInstance);

        markersCluster = L.markerClusterGroup({
            showCoverageOnHover: false,
            maxClusterRadius: 50
        });
        mapInstance.addLayer(markersCluster);
    }

    function renderMarkers(data, focusId) {
        if (!markersCluster) return;
        markersCluster.clearLayers();

        currentFocusMarker = null;

        data.forEach(item => {
            const isFocused = (item.id == focusId);

            // Custom Icon
            // Use Thumbnail if available, else standard pin
            const iconHtml = `
                <div class="custom-pin ${isFocused ? 'current-photo-pin' : ''}" 
                     style="width: 48px; height: 48px; background-image: url('${item.thumbnail || '/static/placeholder.png'}'); background-size: cover; background-position: center;">
                </div>
            `;

            const customIcon = L.divIcon({
                html: iconHtml,
                className: '', // Clear default
                iconSize: [48, 48],
                iconAnchor: [24, 24],
                popupAnchor: [0, -24]
            });

            const marker = L.marker([item.lat, item.lng], { icon: customIcon });

            // Popup content
            const popupContent = `
                <div style="text-align: center; cursor: pointer;" onclick="openDetailModal(${item.id})">
                    <img src="${item.thumbnail}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; margin-bottom: 5px;">
                    <br>
                    <strong>${item.date}</strong>
                </div>
            `;
            marker.bindPopup(popupContent);

            markersCluster.addLayer(marker);

            if (isFocused) {
                currentFocusMarker = marker;
            }
        });

        // Special handling for focus marker to maybe open it? 
        // Or just ensure it's visible. 
        // Leaflet Cluster might hide it if zoom is low.
        // We use zoomToShowLayer
        if (currentFocusMarker) {
            markersCluster.zoomToShowLayer(currentFocusMarker, () => {
                currentFocusMarker.openPopup();
            });
        }
    }

    function closeMapModal() {
        const modal = document.getElementById('mapModal');
        modal.style.display = 'none';
        document.body.style.overflow = ''; // Restore scroll
    }

    // Close on click outside
    document.getElementById('mapModal').addEventListener('click', function (event) {
        if (event.target === this) {
            closeMapModal();
        }
    });

    // Escape listener is in base.html or script.js globally, duplicate is fine
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && document.getElementById('mapModal').style.display === 'flex') {
            closeMapModal();
        }
    });
</script>