{% extends "base.html" %}

{% block content %}
<section class="form-section">
    <h2>Add New Memory</h2>
    {% if msg %}
    <div class="alert success">{{ msg }}</div>
    {% endif %}
    <form id="uploadForm" action="/add" method="post" enctype="multipart/form-data" class="capsule-form">
        <label>Date (Optional)</label>
        <input type="date" name="date">

        <label>Photos & Videos (Select Multiple)</label>
        <div class="file-inputs">
            <input type="file" name="files" multiple accept="image/*,video/*" id="fileInput" class="hidden-input">
            <label for="fileInput" class="file-btn gallery-btn">üñºÔ∏è Select from Gallery</label>

            <input type="file" name="files" accept="image/*" capture="environment" id="cameraInput"
                class="hidden-input">
            <label for="cameraInput" class="file-btn camera-btn">üì∏ Take Photo</label>
        </div>
        <p id="fileCount" class="file-count"></p>

        <label>Title (Optional)</label>
        <input type="text" name="title" placeholder="e.g. 1Ï£ºÎÖÑ Ïó¨Ìñâ">

        <label>Description (Optional)</label>
        <textarea name="description" placeholder="Í∑∏ÎÇ†Ïùò Í∏∞Ïñµ..."></textarea>



        <div class="progress-container" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        <p id="statusText" style="text-align: center; margin-top: 0.5rem; display: none;"></p>

        <button type="submit" id="submitBtn">Add Memory</button>
        <a href="/" class="back-link">Back to Home</a>
    </form>
</section>

<style>
    .form-section {
        padding-top: 100px;
    }

    .file-inputs {
        display: flex;
        gap: 1rem;
        margin-bottom: 0.5rem;
    }

    .hidden-input {
        display: none;
    }

    .file-btn {
        flex: 1;
        padding: 1rem;
        border-radius: 10px;
        text-align: center;
        cursor: pointer;
        font-weight: bold;
        transition: transform 0.1s;
        border: 2px solid transparent;
    }

    .file-btn:active {
        transform: scale(0.96);
    }

    .gallery-btn {
        background: #f0f0f0;
        color: #333;
        border-color: #ddd;
    }

    .camera-btn {
        background: var(--primary-color);
        color: white;
    }

    .file-count {
        font-size: 0.9rem;
        color: var(--accent-color);
        margin-bottom: 1rem;
        font-weight: bold;
    }

    .back-link {
        display: block;
        text-align: center;
        margin-top: 1rem;
        color: var(--primary-color);
    }

    /* ... existing alert/progress styles ... */
    .alert {
        padding: 1rem;
        background: #d4edda;
        color: #155724;
        border-radius: 5px;
        margin-bottom: 1rem;
    }

    .progress-container {
        width: 100%;
        background-color: #f3f3f3;
        border-radius: 5px;
        margin-top: 1rem;
        overflow: hidden;
    }

    .progress-bar {
        width: 0%;
        height: 30px;
        background-color: var(--accent-color);
        text-align: center;
        line-height: 30px;
        color: black;
        transition: width 0.3s;
    }
</style>

<script>
    const form = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const cameraInput = document.getElementById('cameraInput');
    const fileCount = document.getElementById('fileCount');
    const progressBar = document.getElementById('progressBar');
    const progressContainer = document.getElementById('progressContainer');
    const statusText = document.getElementById('statusText');
    const submitBtn = document.getElementById('submitBtn');

    function updateCount() {
        const gCount = fileInput.files.length;
        const cCount = cameraInput.files.length;
        const total = gCount + cCount;
        if (total > 0) {
            fileCount.innerText = `${total} files selected`;
        } else {
            fileCount.innerText = "";
        }
    }

    fileInput.addEventListener('change', updateCount);
    cameraInput.addEventListener('change', updateCount);

    form.addEventListener('submit', (e) => {
        e.preventDefault();

        // Validate Total Files
        const totalFiles = fileInput.files.length + cameraInput.files.length;
        if (totalFiles === 0) {
            alert("Please select or take at least one photo.");
            return;
        }

        const formData = new FormData(form);
        const xhr = new XMLHttpRequest();

        // Show progress UI
        progressContainer.style.display = 'block';
        statusText.style.display = 'block';
        submitBtn.disabled = true;
        submitBtn.innerText = "Uploading...";

        xhr.open('POST', '/add', true);

        xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percentComplete + '%';
                progressBar.innerText = percentComplete + '%';
                statusText.innerText = `Uploading ${totalFiles} files... (${percentComplete}%)`;
            }
        };

        xhr.onload = () => {
            if (xhr.status === 200) {
                statusText.innerText = "Upload Complete! Processing...";
                progressBar.style.backgroundColor = '#4CAF50'; // Green
                setTimeout(() => {
                    window.location.href = "/";
                }, 1000);
            } else {
                statusText.innerText = "Upload Failed. Please try again.";
                submitBtn.disabled = false;
                submitBtn.innerText = "Add Memory";
            }
        };

        xhr.onerror = () => {
            statusText.innerText = "Network Error.";
            submitBtn.disabled = false;
            submitBtn.innerText = "Add Memory";
        };

        xhr.send(formData);
    });
</script>
{% endblock %}